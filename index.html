<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KILL STARS - MULTIPLAYER</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a3b2e;
            touch-action: none;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #4caf7a;
            touch-action: none;
        }
        /* Lobby */
        #lobby {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(145deg, #1e3c2c, #0f2819);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            color: white;
            text-shadow: 4px 4px 0 #00000080;
            backdrop-filter: blur(8px);
            padding: 20px;
            overflow-y: auto;
        }
        #lobby h1 {
            font-size: min(15vw, 80px);
            margin-bottom: 10px;
            color: #ffe484;
            text-shadow: 5px 5px 0 #b45f06;
            text-align: center;
        }
        .player-info {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .player-name-input {
            background: #2a4a3a;
            border: 2px solid gold;
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            width: 200px;
        }
        .player-id {
            background: #2a4a3a;
            border: 2px solid gold;
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
        }
        .stats-container {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .stat-box {
            background: #2a4a3a;
            border: 3px solid gold;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 0 #1a2e22;
        }
        .room-section {
            width: 100%;
            max-width: 800px;
            background: #2a4a3a;
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
            border: 3px solid gold;
        }
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .room-header h2 {
            font-size: 28px;
        }
        .room-actions button {
            background: gold;
            border: none;
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 18px;
            font-weight: bold;
            margin: 0 5px;
            cursor: pointer;
        }
        .player-slots {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .slot {
            width: 100px;
            height: 120px;
            background: #1f2e25;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid gold;
        }
        .slot .emoji {
            font-size: 40px;
        }
        .slot .name {
            font-size: 14px;
        }
        .slot.empty {
            opacity: 0.5;
        }
        .chat-box {
            background: #1f2e25;
            border-radius: 30px;
            padding: 15px;
            margin-top: 15px;
        }
        .chat-messages {
            height: 100px;
            overflow-y: auto;
            margin-bottom: 10px;
            text-align: left;
        }
        .chat-input {
            display: flex;
        }
        .chat-input input {
            flex: 1;
            background: #2a4a3a;
            border: 2px solid gold;
            border-radius: 40px;
            padding: 8px 15px;
            color: white;
        }
        .chat-input button {
            background: gold;
            border: none;
            border-radius: 40px;
            padding: 8px 20px;
            margin-left: 10px;
            font-weight: bold;
        }
        .brawler-showcase {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
        }
        .arrow {
            font-size: min(60px, 12vw);
            background: rgba(255,215,0,0.5);
            width: min(80px, 15vw);
            height: min(80px, 15vw);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid gold;
            color: white;
            cursor: pointer;
            touch-action: manipulation;
            transition: 0.1s;
            box-shadow: 0 5px 0 #a05f00;
        }
        .arrow:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #a05f00;
        }
        .brawler-card-large {
            background: #3d5e4a;
            border-radius: 40px;
            padding: 20px;
            width: min(350px, 70vw);
            text-align: center;
            border: 6px solid gold;
            box-shadow: 0 20px 0 #1a2e22, 0 30px 30px black;
        }
        .brawler-emoji-large {
            font-size: min(120px, 25vw);
            filter: drop-shadow(5px 10px 0 #000);
        }
        .brawler-name-large {
            font-size: min(48px, 10vw);
            font-weight: bold;
            color: #ffe484;
        }
        .brawler-stats-large {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            font-size: min(24px, 5vw);
            background: #1f2e25;
            padding: 15px;
            border-radius: 50px;
        }
        .skin-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }
        .skin-arrow {
            background: gold;
            width: min(40px, 8vw);
            height: min(40px, 8vw);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(30px, 6vw);
            cursor: pointer;
            border: 2px solid white;
        }
        .skin-name {
            font-size: min(20px, 4vw);
            background: #1f2e25;
            padding: 5px 20px;
            border-radius: 30px;
        }
        .shop-button {
            background: #f9b81b;
            border: 4px solid #fff;
            border-radius: 60px;
            padding: min(15px, 3vw) min(40px, 10vw);
            font-size: min(32px, 7vw);
            font-weight: bold;
            color: #3d2b1a;
            text-shadow: 2px 2px 0 #fff;
            box-shadow: 0 10px 0 #a05f00, 0 15px 15px black;
            margin: 20px 0 10px;
            cursor: pointer;
            touch-action: manipulation;
            transition: 0.07s;
        }
        .shop-button:active {
            transform: translateY(8px);
            box-shadow: 0 2px 0 #a05f00, 0 10px 10px black;
        }
        .play-button {
            background: #f9b81b;
            border: 5px solid #fff;
            border-radius: 60px;
            padding: min(20px, 4vw) min(80px, 15vw);
            font-size: min(48px, 10vw);
            font-weight: bold;
            color: #3d2b1a;
            text-shadow: 3px 3px 0 #fff;
            box-shadow: 0 15px 0 #a05f00, 0 20px 20px black;
            margin-top: 20px;
            cursor: pointer;
            touch-action: manipulation;
            transition: 0.07s;
        }
        .play-button:active {
            transform: translateY(10px);
            box-shadow: 0 5px 0 #a05f00, 0 15px 15px black;
        }
        #shopOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 30;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            overflow-y: auto;
            color: white;
            backdrop-filter: blur(10px);
        }
        #shopOverlay h2 {
            font-size: min(60px, 12vw);
            color: gold;
            margin: 20px 0;
        }
        .shop-coins {
            font-size: min(30px, 6vw);
            background: #2a4a3a;
            border: 2px solid gold;
            border-radius: 40px;
            padding: 10px 30px;
            margin-bottom: 20px;
        }
        .shop-brawler-section {
            width: 100%;
            max-width: 600px;
            background: #2a4a3a;
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .shop-brawler-title {
            font-size: min(30px, 6vw);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .shop-skin-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1f2e25;
            border-radius: 30px;
            padding: 10px 20px;
            margin-bottom: 10px;
        }
        .shop-skin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .shop-skin-emoji {
            font-size: 40px;
        }
        .shop-skin-name {
            font-size: min(20px, 4vw);
        }
        .shop-skin-price {
            background: gold;
            color: black;
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: bold;
        }
        .shop-buy-btn {
            background: #4caf50;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: min(18px, 3.5vw);
            font-weight: bold;
            cursor: pointer;
        }
        .close-shop {
            background: #c0392b;
            border: 3px solid white;
            border-radius: 50px;
            padding: 15px 50px;
            font-size: 30px;
            margin: 30px;
            cursor: pointer;
        }
        /* HUD */
        #hud {
            position: absolute;
            top: 15px; left: 15px; right: 15px;
            display: flex;
            justify-content: space-between;
            color: white;
            text-shadow: 3px 3px 0 #000;
            font-size: min(28px, 6vw);
            font-weight: bold;
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(6px);
            border: 2px solid gold;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        #wave {
            background: #2f5575;
            padding: 8px 20px;
            border-radius: 40px;
        }
        #score {
            background: #8b5a2b;
            padding: 8px 20px;
            border-radius: 40px;
        }
        #hpBar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 20px;
            border-radius: 40px;
        }
        #hpFill {
            width: min(150px, 30vw);
            height: 20px;
            background: #c0392b;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid white;
        }
        #hpCurrent {
            height: 100%;
            width: 100%;
            background: #2ecc71;
        }
        #powerCubesHUD {
            background: #b8860b;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #ammoHUD {
            background: #2c3e50;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .ammo-bars {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        .ammo-bar {
            width: 20px;
            height: 20px;
            background: #555;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid white;
        }
        .ammo-bar-fill {
            height: 100%;
            width: 0%;
            background: #ffaa00;
            transition: width 0.1s;
        }
        .joystick {
            position: absolute;
            width: min(130px, 28vw);
            height: min(130px, 28vw);
            background: rgba(30,30,30,0.7);
            border-radius: 50%;
            touch-action: none;
            z-index: 15;
            backdrop-filter: blur(8px);
            border: 4px solid rgba(255,215,0,0.8);
            box-shadow: 0 0 30px black;
        }
        #leftJoystick {
            bottom: max(30px, 6vh);
            left: max(20px, 4vw);
        }
        #rightJoystick {
            bottom: max(30px, 6vh);
            right: max(150px, 22vw);
        }
        .joystickKnob {
            position: absolute;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle at 30% 30%, #fff, #ccc);
            border-radius: 50%;
            top: 20%;
            left: 20%;
            pointer-events: none;
            box-shadow: 0 5px 15px black;
            border: 3px solid #ffd966;
            transition: 0.02s;
        }
        #specialButton {
            position: absolute;
            bottom: max(180px, 24vh);
            right: max(30px, 5vw);
            width: min(100px, 22vw);
            height: min(100px, 22vw);
            border-radius: 50%;
            background: #444;
            border: 5px solid #fff;
            color: white;
            font-weight: bold;
            font-size: min(16px, 3.5vw);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px black;
            z-index: 15;
            touch-action: none;
            flex-direction: column;
            text-shadow: 2px 2px 0 #000;
            transition: 0.1s;
        }
        #specialButton .special-charge {
            font-size: min(26px, 6vw);
            font-weight: bold;
        }
        #specialButton.ready {
            background: #ff7b00;
            animation: pulse 0.6s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.15); }
        }
        #gameOver {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: min(60px, 12vw);
            backdrop-filter: blur(10px);
            text-align: center;
            padding: 20px;
        }
        #gameOver button {
            background: gold;
            border: none;
            padding: min(20px, 5vw) min(60px, 15vw);
            font-size: min(40px, 8vw);
            border-radius: 60px;
            margin: 30px;
            font-weight: bold;
            touch-action: manipulation;
        }
        @media (orientation: portrait) {
            #hud {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <!-- Vanilla Party f√ºr Multiplayer -->
    <script src="https://unpkg.com/vanilla-party@latest/dist/vanilla-party.js"></script>
</head>
<body>
    <!-- Lobby -->
    <div id="lobby">
        <h1>KILL STARS</h1>
        <div class="player-info">
            <input type="text" id="playerNameInput" class="player-name-input" placeholder="Dein Name" maxlength="20" value="Spieler">
            <div class="player-id" id="playerIdDisplay" onclick="copyID()">ID: ...</div>
        </div>
        <div class="stats-container">
            <div class="stat-box"><span>üí∞</span> <span id="totalCoinsDisplay">0</span></div>
            <div class="stat-box"><span>üèÜ</span> <span id="highScoreDisplay">0</span></div>
            <div class="stat-box"><span>üåä</span> <span id="maxWaveDisplay">1</span></div>
        </div>

        <!-- Raum-Bereich (ersetzt Freundesliste) -->
        <div class="room-section">
            <div class="room-header">
                <h2>üéÆ Raum</h2>
                <div class="room-actions">
                    <button id="createRoomBtn">Raum erstellen</button>
                    <button id="joinRoomBtn">Raum beitreten</button>
                </div>
            </div>
            <div id="roomStatus">Kein Raum. Erstelle einen oder tritt einem bei.</div>
            <div class="player-slots" id="playerSlots">
                <div class="slot" id="slot1"><div class="emoji" id="slot1Emoji">ü§î</div><div class="name" id="slot1Name">--</div></div>
                <div class="slot" id="slot2"><div class="emoji" id="slot2Emoji">ü§î</div><div class="name" id="slot2Name">--</div></div>
                <div class="slot" id="slot3"><div class="emoji" id="slot3Emoji">ü§î</div><div class="name" id="slot3Name">--</div></div>
            </div>
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Nachricht...">
                    <button id="sendChatBtn">Senden</button>
                </div>
            </div>
            <button id="startMultiplayerBtn" class="play-button" style="margin-top:10px; display:none;">Spiel starten</button>
        </div>

        <!-- Brawler-Auswahl (wie gehabt) -->
        <div class="brawler-showcase">
            <div class="arrow" id="prevBrawler">‚óÄ</div>
            <div class="brawler-card-large" id="brawlerCard">
                <div class="brawler-emoji-large" id="brawlerEmoji">üî´</div>
                <div class="brawler-name-large" id="brawlerName">Shelly</div>
                <div class="brawler-stats-large">
                    <span>‚ù§Ô∏è <span id="brawlerHp">100</span></span>
                    <span>‚ö° <span id="brawlerSpeed">3.2</span></span>
                    <span>üî´ <span id="brawlerDmg">20</span></span>
                </div>
                <div class="skin-selector">
                    <div class="skin-arrow" id="prevSkin">‚óÄ</div>
                    <div class="skin-name" id="skinName">Standard</div>
                    <div class="skin-arrow" id="nextSkin">‚ñ∂</div>
                </div>
            </div>
            <div class="arrow" id="nextBrawler">‚ñ∂</div>
        </div>

        <div class="shop-button" id="openShopBtn">üõí SHOP</div>
        <div class="play-button" id="playBtn">‚öîÔ∏è K√ÑMPFEN (Solo)</div>
    </div>

    <!-- Shop Overlay -->
    <div id="shopOverlay">
        <h2>üõí SKIN-SHOP</h2>
        <div class="shop-coins">üí∞ <span id="shopCoins">0</span></div>
        <div id="shopContent"></div>
        <div class="close-shop" id="closeShopBtn">üîô SCHLIESSEN</div>
    </div>

    <!-- Game Over -->
    <div id="gameOver">
        <div id="gameOverMessage">üíÄ GAME OVER üíÄ</div>
        <div id="finalScore"></div>
        <button id="restartBtn">NEU STARTEN</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="wave">üåä Welle 1</div>
        <div id="hpBar">
            ‚ù§Ô∏è
            <div id="hpFill"><div id="hpCurrent"></div></div>
        </div>
        <div id="score">üèÜ 0</div>
        <div id="powerCubesHUD" style="display:none;">üì¶ <span id="powerCubesCount">0</span></div>
        <div id="ammoHUD" style="display:none;">
            <span>üî´</span>
            <div class="ammo-bars" id="ammoBars">
                <div class="ammo-bar"><div class="ammo-bar-fill" id="ammoBar1"></div></div>
                <div class="ammo-bar"><div class="ammo-bar-fill" id="ammoBar2"></div></div>
                <div class="ammo-bar"><div class="ammo-bar-fill" id="ammoBar3"></div></div>
            </div>
        </div>
    </div>
    <div id="leftJoystick" class="joystick"><div class="joystickKnob" id="leftKnob"></div></div>
    <div id="rightJoystick" class="joystick"><div class="joystickKnob" id="rightKnob"></div></div>
    <div id="specialButton"><span class="special-charge">0%</span><span>SPEZIAL</span></div>

    <script>
        (function() {
            // ==================== GRUNDSETUP ====================
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            // Lobby-Elemente
            const lobby = document.getElementById('lobby');
            const prevBrawlerBtn = document.getElementById('prevBrawler');
            const nextBrawlerBtn = document.getElementById('nextBrawler');
            const brawlerEmoji = document.getElementById('brawlerEmoji');
            const brawlerName = document.getElementById('brawlerName');
            const brawlerHp = document.getElementById('brawlerHp');
            const brawlerSpeed = document.getElementById('brawlerSpeed');
            const brawlerDmg = document.getElementById('brawlerDmg');
            const prevSkinBtn = document.getElementById('prevSkin');
            const nextSkinBtn = document.getElementById('nextSkin');
            const skinNameSpan = document.getElementById('skinName');
            const playBtn = document.getElementById('playBtn');
            const openShopBtn = document.getElementById('openShopBtn');
            const shopOverlay = document.getElementById('shopOverlay');
            const closeShopBtn = document.getElementById('closeShopBtn');
            const shopContent = document.getElementById('shopContent');
            const shopCoinsSpan = document.getElementById('shopCoins');
            const totalCoinsDisplay = document.getElementById('totalCoinsDisplay');
            const highScoreDisplay = document.getElementById('highScoreDisplay');
            const maxWaveDisplay = document.getElementById('maxWaveDisplay');

            // Map-Buttons (fest auf grass, desert, ice ‚Äì wir lassen sie erstmal)
            // F√ºr Multiplayer nutzen wir nur Wellen-Modus, aber der Einfachheit halber.

            // HUD-Elemente
            const waveDisplay = document.getElementById('wave');
            const scoreDisplay = document.getElementById('score');
            const hpCurrent = document.getElementById('hpCurrent');
            const specialBtn = document.getElementById('specialButton');
            const powerCubesHUD = document.getElementById('powerCubesHUD');
            const powerCubesCount = document.getElementById('powerCubesCount');
            const ammoHUD = document.getElementById('ammoHUD');
            const ammoBar1 = document.getElementById('ammoBar1');
            const ammoBar2 = document.getElementById('ammoBar2');
            const ammoBar3 = document.getElementById('ammoBar3');

            // GameOver
            const gameOverDiv = document.getElementById('gameOver');
            const gameOverMessage = document.getElementById('gameOverMessage');
            const finalScoreSpan = document.getElementById('finalScore');
            const restartBtn = document.getElementById('restartBtn');

            // Joysticks
            const leftJoystick = document.getElementById('leftJoystick');
            const rightJoystick = document.getElementById('rightJoystick');
            const leftKnob = document.getElementById('leftKnob');
            const rightKnob = document.getElementById('rightKnob');

            // Multiplayer-Elemente
            const playerNameInput = document.getElementById('playerNameInput');
            const playerIdDisplay = document.getElementById('playerIdDisplay');
            const createRoomBtn = document.getElementById('createRoomBtn');
            const joinRoomBtn = document.getElementById('joinRoomBtn');
            const roomStatus = document.getElementById('roomStatus');
            const slot1Emoji = document.getElementById('slot1Emoji');
            const slot1Name = document.getElementById('slot1Name');
            const slot2Emoji = document.getElementById('slot2Emoji');
            const slot2Name = document.getElementById('slot2Name');
            const slot3Emoji = document.getElementById('slot3Emoji');
            const slot3Name = document.getElementById('slot3Name');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const startMultiplayerBtn = document.getElementById('startMultiplayerBtn');

            // ==================== SPIELER-ID (einfach generieren) ====================
            let playerId = localStorage.getItem('killStars_playerId');
            if (!playerId) {
                playerId = 'P' + Math.random().toString(36).substring(2, 10).toUpperCase();
                localStorage.setItem('killStars_playerId', playerId);
            }
            playerIdDisplay.innerHTML = 'ID: ' + playerId;

            window.copyID = function() {
                navigator.clipboard.writeText(playerId).then(() => alert('ID kopiert!'));
            };

            // Spielername
            let playerName = localStorage.getItem('killStars_playerName') || 'Spieler';
            playerNameInput.value = playerName;
            playerNameInput.addEventListener('input', (e) => {
                playerName = e.target.value.trim() || 'Spieler';
                localStorage.setItem('killStars_playerName', playerName);
            });

            // ==================== SKIN-DATEN (gek√ºrzt) ====================
            const skinData = {
                Shelly: [
                    { name: 'Standard', emoji: 'üî´', color: '#e67e22', hat: 'üß¢', price: 0 },
                    { name: 'Gold-Shelly', emoji: 'üî´‚ú®', color: '#f1c40f', hat: 'üëë', price: 5000 },
                    { name: 'Nacht-Shelly', emoji: 'üî´üåô', color: '#2c3e50', hat: 'üé©', price: 10000 }
                ],
                Colt: [
                    { name: 'Standard', emoji: 'üî´üî´', color: '#3498db', hat: 'ü§†', price: 0 },
                    { name: 'Feuer-Colt', emoji: 'üî•üî´', color: '#e67e22', hat: 'üî•', price: 5000 },
                    { name: 'Eis-Colt', emoji: '‚ùÑÔ∏èüî´', color: '#5dade2', hat: '‚ùÑÔ∏è', price: 10000 }
                ],
                Bull: [
                    { name: 'Standard', emoji: 'üêÇ', color: '#c0392b', hat: '‚õëÔ∏è', price: 0 },
                    { name: 'Kampf-Bull', emoji: 'üêÇ‚öîÔ∏è', color: '#7f8c8d', hat: '‚õëÔ∏è‚öîÔ∏è', price: 5000 },
                    { name: 'Robo-Bull', emoji: 'ü§ñüêÇ', color: '#2c3e50', hat: 'üî©', price: 10000 }
                ]
            };

            let ownedSkins = JSON.parse(localStorage.getItem('killStars_ownedSkins')) || {
                Shelly: [true, false, false],
                Colt: [true, false, false],
                Bull: [true, false, false]
            };
            let selectedSkinIndices = JSON.parse(localStorage.getItem('killStars_selectedSkins')) || {
                Shelly: 0,
                Colt: 0,
                Bull: 0
            };

            let totalCoins = parseInt(localStorage.getItem('killStars_totalCoins')) || 0;
            let highScore = parseInt(localStorage.getItem('killStars_highScore')) || 0;
            let maxWave = parseInt(localStorage.getItem('killStars_maxWave')) || 1;

            function saveStats() {
                localStorage.setItem('killStars_totalCoins', totalCoins);
                localStorage.setItem('killStars_highScore', highScore);
                localStorage.setItem('killStars_maxWave', maxWave);
                localStorage.setItem('killStars_ownedSkins', JSON.stringify(ownedSkins));
                localStorage.setItem('killStars_selectedSkins', JSON.stringify(selectedSkinIndices));
            }

            function updateLobbyStats() {
                totalCoinsDisplay.textContent = totalCoins;
                highScoreDisplay.textContent = highScore;
                maxWaveDisplay.textContent = maxWave;
            }
            updateLobbyStats();

            const brawlersList = [
                { name: 'Shelly', baseHp: 100, speed: 3.2, baseDamage: 20,
                  attackDamage: 20, attackSpeed: 8, attackRange: 350, attackSpread: 5, attackCooldown: 300,
                  specialDamage: 40, specialSpeed: 12, specialRange: 450, specialSpread: 9, specialType: 'shotgun' },
                { name: 'Colt', baseHp: 80, speed: 4.0, baseDamage: 30,
                  attackDamage: 30, attackSpeed: 14, attackRange: 600, attackSpread: 1, attackCooldown: 250,
                  specialDamage: 25, specialSpeed: 16, specialRange: 700, specialSpread: 8, specialType: 'rapid' },
                { name: 'Bull', baseHp: 130, speed: 2.5, baseDamage: 50,
                  attackDamage: 50, attackSpeed: 9, attackRange: 220, attackSpread: 1, attackCooldown: 350,
                  specialDamage: 90, specialSpeed: 22, specialRange: 300, specialSpread: 1, specialType: 'dash' }
            ];

            let selectedBrawlerIndex = 0;
            let currentBrawlerName = 'Shelly';

            function updateBrawlerDisplay() {
                const b = brawlersList[selectedBrawlerIndex];
                currentBrawlerName = b.name;
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                brawlerEmoji.textContent = skin.emoji;
                brawlerName.textContent = b.name;
                brawlerHp.textContent = b.baseHp;
                brawlerSpeed.textContent = b.speed;
                brawlerDmg.textContent = b.baseDamage;
                skinNameSpan.textContent = skin.name;
            }

            function updateSkinDisplay() {
                const b = brawlersList[selectedBrawlerIndex];
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                brawlerEmoji.textContent = skin.emoji;
                skinNameSpan.textContent = skin.name;
            }

            prevBrawlerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex - 1 + brawlersList.length) % brawlersList.length;
                updateBrawlerDisplay();
            });
            nextBrawlerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex + 1) % brawlersList.length;
                updateBrawlerDisplay();
            });

            function cycleSkin(direction) {
                const b = brawlersList[selectedBrawlerIndex];
                const owned = ownedSkins[b.name];
                let current = selectedSkinIndices[b.name];
                let newIndex = current;
                do {
                    newIndex = (newIndex + direction + owned.length) % owned.length;
                } while (!owned[newIndex] && newIndex !== current);
                if (owned[newIndex]) {
                    selectedSkinIndices[b.name] = newIndex;
                    saveStats();
                    updateSkinDisplay();
                }
            }
            prevSkinBtn.addEventListener('click', (e) => { e.preventDefault(); cycleSkin(-1); });
            nextSkinBtn.addEventListener('click', (e) => { e.preventDefault(); cycleSkin(1); });

            // Shop (vereinfacht)
            function openShop() {
                shopOverlay.style.display = 'flex';
                renderShop();
            }
            function closeShop() {
                shopOverlay.style.display = 'none';
            }
            openShopBtn.addEventListener('click', openShop);
            closeShopBtn.addEventListener('click', closeShop);

            function renderShop() {
                shopCoinsSpan.textContent = totalCoins;
                let html = '';
                for (let brawler of brawlersList) {
                    html += `<div class="shop-brawler-section">`;
                    html += `<div class="shop-brawler-title"><span>${skinData[brawler.name][0].emoji}</span> ${brawler.name}</div>`;
                    for (let i = 0; i < skinData[brawler.name].length; i++) {
                        const skin = skinData[brawler.name][i];
                        const owned = ownedSkins[brawler.name][i];
                        html += `<div class="shop-skin-item">`;
                        html += `<div class="shop-skin-info">`;
                        html += `<span class="shop-skin-emoji">${skin.emoji}</span>`;
                        html += `<span class="shop-skin-name">${skin.name}</span>`;
                        html += `</div>`;
                        if (owned) {
                            html += `<span class="shop-skin-price">‚úîÔ∏è Besitzt</span>`;
                        } else {
                            html += `<span class="shop-skin-price">üí∞ ${skin.price}</span>`;
                            html += `<button class="shop-buy-btn" data-brawler="${brawler.name}" data-skinindex="${i}">Kaufen</button>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
                shopContent.innerHTML = html;

                document.querySelectorAll('.shop-buy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const brawler = e.target.dataset.brawler;
                        const skinIndex = parseInt(e.target.dataset.skinindex);
                        const price = skinData[brawler][skinIndex].price;
                        if (totalCoins >= price && !ownedSkins[brawler][skinIndex]) {
                            totalCoins -= price;
                            ownedSkins[brawler][skinIndex] = true;
                            saveStats();
                            updateLobbyStats();
                            renderShop();
                        }
                    });
                });
            }

            // ==================== MULTIPLAYER MIT VANILLA PARTY ====================
            let room = null;
            let playersInRoom = {}; // { playerId: { name, emoji, x, y, hp, ... } }
            let isHost = false;

            // Verbindung zum Vanilla-Party-Server
            const SERVER_URL = "wss://vanilla-party.luizbills.com";
            const APP_NAME = "kill-stars-multi";

            // Raum erstellen
            createRoomBtn.addEventListener('click', () => {
                const roomName = prompt("Raumname eingeben (z.B. 'meinRaum123'):");
                if (!roomName) return;
                partyConnect(SERVER_URL, APP_NAME, roomName);
                room = partyLoadMyRoom();
                isHost = true;
                roomStatus.innerText = `Raum: ${roomName} (Host)`;
                // Host wartet auf Beitritte
                room.onPeerJoin = (peerId) => {
                    addChatMessage({ name: 'System', message: `Spieler ${peerId} ist beigetreten.` });
                    // Sende eigene Daten an neuen Spieler
                    room.send(peerId, {
                        type: 'playerData',
                        data: {
                            id: playerId,
                            name: playerName,
                            emoji: brawlerEmoji.textContent,
                            x: canvas.width/2,
                            y: canvas.height/2,
                            hp: 100
                        }
                    });
                };
                room.onPeerLeave = (peerId) => {
                    addChatMessage({ name: 'System', message: `Spieler ${peerId} hat verlassen.` });
                    delete playersInRoom[peerId];
                    updateSlots();
                };
                room.onMessage = (senderId, message) => {
                    if (message.type === 'playerData') {
                        playersInRoom[senderId] = message.data;
                        updateSlots();
                    } else if (message.type === 'chat') {
                        addChatMessage({ name: message.from, message: message.text });
                    } else if (message.type === 'startGame') {
                        startMultiplayerGame();
                    }
                };
                // Eigenen Eintrag hinzuf√ºgen
                playersInRoom[playerId] = {
                    name: playerName,
                    emoji: brawlerEmoji.textContent,
                    x: canvas.width/2,
                    y: canvas.height/2,
                    hp: 100
                };
                updateSlots();
                startMultiplayerBtn.style.display = 'inline-block';
            });

            // Raum beitreten
            joinRoomBtn.addEventListener('click', () => {
                const roomName = prompt("Gib den Raumnamen ein:");
                if (!roomName) return;
                partyConnect(SERVER_URL, APP_NAME, roomName);
                room = partyLoadMyRoom();
                isHost = false;
                roomStatus.innerText = `Raum: ${roomName} (Gast)`;
                // Eigene Daten an alle senden
                room.send({
                    type: 'playerData',
                    data: {
                        id: playerId,
                        name: playerName,
                        emoji: brawlerEmoji.textContent,
                        x: canvas.width/2,
                        y: canvas.height/2,
                        hp: 100
                    }
                });
                room.onMessage = (senderId, message) => {
                    if (message.type === 'playerData') {
                        playersInRoom[senderId] = message.data;
                        updateSlots();
                    } else if (message.type === 'chat') {
                        addChatMessage({ name: message.from, message: message.text });
                    } else if (message.type === 'startGame') {
                        startMultiplayerGame();
                    }
                };
                room.onPeerLeave = (peerId) => {
                    addChatMessage({ name: 'System', message: `Spieler ${peerId} hat verlassen.` });
                    delete playersInRoom[peerId];
                    updateSlots();
                };
                playersInRoom[playerId] = {
                    name: playerName,
                    emoji: brawlerEmoji.textContent,
                    x: canvas.width/2,
                    y: canvas.height/2,
                    hp: 100
                };
                updateSlots();
            });

            function updateSlots() {
                const slots = [slot1Emoji, slot1Name, slot2Emoji, slot2Name, slot3Emoji, slot3Name];
                // Leeren
                for (let i = 0; i < 3; i++) {
                    slots[i*2].textContent = 'ü§î';
                    slots[i*2+1].textContent = '--';
                }
                let index = 0;
                for (let id in playersInRoom) {
                    if (index >= 3) break;
                    const p = playersInRoom[id];
                    slots[index*2].textContent = p.emoji || 'ü§î';
                    slots[index*2+1].textContent = p.name || id.substring(0,6);
                    index++;
                }
            }

            function addChatMessage(msg) {
                chatMessages.innerHTML += `<div><b>${msg.name}:</b> ${msg.message}</div>`;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            sendChatBtn.addEventListener('click', () => {
                const msg = chatInput.value.trim();
                if (msg && room) {
                    room.send({
                        type: 'chat',
                        from: playerName,
                        text: msg
                    });
                    addChatMessage({ name: playerName, message: msg });
                    chatInput.value = '';
                }
            });

            startMultiplayerBtn.addEventListener('click', () => {
                if (room && isHost) {
                    room.send({ type: 'startGame' });
                    startMultiplayerGame();
                }
            });

            function startMultiplayerGame() {
                // Verstecke Lobby, zeige Spiel
                lobby.style.display = 'none';
                gameActive = true;
                gameMode = 'waves'; // Einfach Wellen-Modus f√ºr alle
                wave = 1;
                score = 0;
                enemies = [];
                projectiles = [];
                coins = [];
                powerCubes = [];
                effects = [];
                damageNumbers = [];
                // Spieler initialisieren (lokaler Spieler)
                const b = brawlersList[selectedBrawlerIndex];
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                player = {
                    name: b.name,
                    hp: b.baseHp,
                    maxHp: b.baseHp,
                    speed: b.speed,
                    attackDamage: b.attackDamage,
                    attackSpeed: b.attackSpeed,
                    attackRange: b.attackRange,
                    attackSpread: b.attackSpread,
                    attackCooldown: b.attackCooldown,
                    specialDamage: b.specialDamage,
                    specialSpeed: b.specialSpeed,
                    specialRange: b.specialRange,
                    specialSpread: b.specialSpread,
                    specialType: b.specialType,
                    color: skin.color,
                    emoji: skin.emoji,
                    hat: skin.hat,
                    x: canvas.width / 2,
                    y: canvas.height / 2
                };
                startWave();
                // In regelm√§√üigen Abst√§nden eigene Position an andere senden
                setInterval(() => {
                    if (room && gameActive) {
                        room.send({
                            type: 'playerData',
                            data: {
                                id: playerId,
                                name: playerName,
                                emoji: brawlerEmoji.textContent,
                                x: player.x,
                                y: player.y,
                                hp: player.hp
                            }
                        });
                    }
                }, 100); // 10x pro Sekunde
            }

            // ==================== SPIELLOGIK (gek√ºrzt, nur Wellen-Modus) ====================
            let gameActive = false;
            let player = null;
            let enemies = [];
            let projectiles = [];
            let coins = [];
            let powerCubes = [];
            let damageNumbers = [];
            let effects = [];
            let lastShot = 0;
            const MAX_SPECIAL = 100;
            let specialCharge = 0;
            let specialReady = false;
            let wave = 1;
            let score = 0;
            let enemiesThisWave = 0;
            let enemiesSpawned = 0;
            const BASE_ENEMIES = 3;
            let gameMode = 'waves';

            // Joystick-Zust√§nde
            let leftStick = { active: false, id: null, dir: { x: 0, y: 0 } };
            let rightStick = { active: false, id: null, dir: { x: 0, y: 0 }, tap: false, startX: 0, startY: 0 };
            let specialAiming = false;
            let specialDir = { x: 0, y: 0 };
            let specialStartPos = { x: 0, y: 0 };
            let specialTap = false;
            let specialTouchId = null;

            // Joystick-Event-Listener (unver√§ndert)
            function handleTouchStart(e, isRight) { /* ... */ }
            function handleTouchMove(e, isRight) { /* ... */ }
            function handleTouchEnd(e, isRight) { /* ... */ }
            leftJoystick.addEventListener('touchstart', (e) => handleTouchStart(e, false), { passive: false });
            leftJoystick.addEventListener('touchmove', (e) => handleTouchMove(e, false), { passive: false });
            leftJoystick.addEventListener('touchend', (e) => handleTouchEnd(e, false));
            rightJoystick.addEventListener('touchstart', (e) => handleTouchStart(e, true), { passive: false });
            rightJoystick.addEventListener('touchmove', (e) => handleTouchMove(e, true), { passive: false });
            rightJoystick.addEventListener('touchend', (e) => handleTouchEnd(e, true));

            function startWave() {
                enemiesThisWave = BASE_ENEMIES + wave * 2;
                enemiesSpawned = 0;
                enemies = [];
                spawnEnemies();
            }
            function spawnEnemies() {
                if (!gameActive || gameMode !== 'waves') return;
                if (enemiesSpawned < enemiesThisWave) {
                    let angle = Math.random() * 2 * Math.PI;
                    let distance = Math.max(canvas.width, canvas.height) * 0.5;
                    let x = player.x + Math.cos(angle) * distance;
                    let y = player.y + Math.sin(angle) * distance;
                    x = Math.min(canvas.width - 50, Math.max(50, x));
                    y = Math.min(canvas.height - 50, Math.max(50, y));
                    enemies.push({
                        x, y,
                        hp: 40 + wave * 8,
                        maxHp: 40 + wave * 8,
                        speed: 1.2 + wave * 0.1,
                        damage: 5 + wave,
                        radius: 25,
                        color: '#c13b3b',
                        lastDamageTime: 0
                    });
                    enemiesSpawned++;
                    setTimeout(spawnEnemies, 700);
                }
            }

            // Schie√üen (vereinfacht)
            function shootInDirection(dir) {
                if (!player || !gameActive) return;
                let now = Date.now();
                if (now - lastShot < player.attackCooldown) return;
                lastShot = now;
                let bullets = [];
                let baseAngle = Math.atan2(dir.y, dir.x);
                let spread = player.attackSpread || 1;
                if (spread === 1) {
                    bullets.push({
                        x: player.x, y: player.y,
                        vx: dir.x * player.attackSpeed,
                        vy: dir.y * player.attackSpeed,
                        damage: player.attackDamage,
                        range: player.attackRange,
                        owner: 'player',
                        size: 8,
                        color: '#ffcc44'
                    });
                } else {
                    for (let i = -Math.floor(spread/2); i <= Math.floor(spread/2); i++) {
                        let angle = baseAngle + i * 0.2;
                        bullets.push({
                            x: player.x, y: player.y,
                            vx: Math.cos(angle) * player.attackSpeed,
                            vy: Math.sin(angle) * player.attackSpeed,
                            damage: player.attackDamage,
                            range: player.attackRange,
                            owner: 'player',
                            size: 6,
                            color: '#ffaa00'
                        });
                    }
                }
                projectiles.push(...bullets);
            }
            function autoShoot() {
                // finde n√§chsten Gegner und schie√üe
                if (!player || !gameActive) return;
                let closest = null;
                let minDist = Infinity;
                enemies.forEach(e => {
                    let d = Math.hypot(e.x - player.x, e.y - player.y);
                    if (d < minDist) { minDist = d; closest = e; }
                });
                if (closest) {
                    let dx = closest.x - player.x;
                    let dy = closest.y - player.y;
                    let len = Math.hypot(dx, dy);
                    if (len > 0) shootInDirection({ x: dx/len, y: dy/len });
                }
            }

            // Spezial (stark vereinfacht)
            function useSpecialAuto() { /* ... */ }
            specialBtn.addEventListener('touchstart', (e) => { e.preventDefault(); /* ... */ });

            // Hilfsfunktionen
            function addDamageNumber(x, y, amount) { damageNumbers.push({ x, y: y-20, value: amount, life: 60 }); }
            function addEffect(x, y) { effects.push({ x, y, life: 20, maxLife: 20 }); }

            // Update und Draw (stark vereinfacht, nur zur Demo)
            function update() {
                if (!gameActive || !player) return;
                if (leftStick.active) {
                    player.x += leftStick.dir.x * player.speed;
                    player.y += leftStick.dir.y * player.speed;
                    player.x = Math.min(canvas.width-40, Math.max(40, player.x));
                    player.y = Math.min(canvas.height-40, Math.max(40, player.y));
                }
                // Gegner bewegen
                enemies.forEach(e => {
                    let dx = player.x - e.x;
                    let dy = player.y - e.y;
                    let len = Math.hypot(dx, dy);
                    if (len > 0) {
                        e.vx = (dx/len) * e.speed;
                        e.vy = (dy/len) * e.speed;
                    }
                    e.x += e.vx;
                    e.y += e.vy;
                    e.x = Math.min(canvas.width-30, Math.max(30, e.x));
                    e.y = Math.min(canvas.height-30, Math.max(30, e.y));
                });
                // Projektile
                for (let i = projectiles.length-1; i>=0; i--) {
                    let p = projectiles[i];
                    p.x += p.vx; p.y += p.vy;
                    if (p.x<0 || p.x>canvas.width || p.y<0 || p.y>canvas.height) { projectiles.splice(i,1); continue; }
                    for (let j = enemies.length-1; j>=0; j--) {
                        let e = enemies[j];
                        if (Math.hypot(p.x-e.x, p.y-e.y) < e.radius+5) {
                            e.hp -= p.damage;
                            addDamageNumber(e.x, e.y, p.damage);
                            addEffect(p.x, p.y);
                            projectiles.splice(i,1);
                            if (e.hp <= 0) {
                                score += 100;
                                enemies.splice(j,1);
                            }
                            break;
                        }
                    }
                }
                // N√§chste Welle
                if (enemies.length === 0 && enemiesSpawned >= enemiesThisWave) {
                    wave++;
                    startWave();
                }
                // Effekte
                for (let i = effects.length-1; i>=0; i--) {
                    effects[i].life--;
                    if (effects[i].life <= 0) effects.splice(i,1);
                }
                updateUI();
            }

            function updateUI() {
                if (!player) return;
                waveDisplay.innerHTML = `üåä Welle ${wave}`;
                scoreDisplay.innerHTML = `üèÜ ${score}`;
                let percent = (player.hp / player.maxHp) * 100;
                hpCurrent.style.width = percent + '%';
            }

            function draw() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                // Hintergrund
                ctx.fillStyle = '#5aa45a';
                ctx.fillRect(0,0,canvas.width,canvas.height);
                // Gegner
                enemies.forEach(e => {
                    ctx.fillStyle = e.color;
                    ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, 2*Math.PI); ctx.fill();
                    ctx.fillStyle = '#c0392b';
                    ctx.fillRect(e.x-25, e.y-40, 50, 6);
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(e.x-25, e.y-40, 50*(e.hp/e.maxHp), 6);
                });
                // Lokaler Spieler
                if (player) {
                    ctx.fillStyle = player.color;
                    ctx.beginPath(); ctx.arc(player.x, player.y, 30, 0, 2*Math.PI); ctx.fill();
                    ctx.fillStyle = 'white'; ctx.font = '30px Arial';
                    ctx.fillText(player.emoji, player.x-20, player.y-40);
                }
                // Andere Spieler (Multiplayer)
                for (let id in playersInRoom) {
                    if (id === playerId) continue;
                    let p = playersInRoom[id];
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 25, 0, 2*Math.PI); ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.fillText(p.emoji || 'üë§', p.x-15, p.y-30);
                }
                // Projektile
                projectiles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, 2*Math.PI); ctx.fill();
                });
                // Schadenszahlen
                damageNumbers.forEach(d => {
                    ctx.fillStyle = 'red'; ctx.font = '20px Arial';
                    ctx.fillText('-' + d.value, d.x, d.y);
                });
            }

            function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
            gameLoop();

            restartBtn.addEventListener('click', () => {
                gameOverDiv.style.display = 'none';
                lobby.style.display = 'flex';
                updateLobbyStats();
            });

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            updateBrawlerDisplay();

            // Solo-Spiel starten
            playBtn.addEventListener('click', () => {
                lobby.style.display = 'none';
                gameActive = true;
                gameMode = 'waves';
                const b = brawlersList[selectedBrawlerIndex];
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                player = {
                    name: b.name,
                    hp: b.baseHp,
                    maxHp: b.baseHp,
                    speed: b.speed,
                    attackDamage: b.attackDamage,
                    attackSpeed: b.attackSpeed,
                    attackRange: b.attackRange,
                    attackSpread: b.attackSpread,
                    attackCooldown: b.attackCooldown,
                    specialDamage: b.specialDamage,
                    specialSpeed: b.specialSpeed,
                    specialRange: b.specialRange,
                    specialSpread: b.specialSpread,
                    specialType: b.specialType,
                    color: skin.color,
                    emoji: skin.emoji,
                    hat: skin.hat,
                    x: canvas.width/2,
                    y: canvas.height/2
                };
                wave = 1; score = 0; enemies = []; projectiles = []; startWave();
            });
        })();
    </script>
</body>
</html>
