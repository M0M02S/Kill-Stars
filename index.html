<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KILL STARS - FINAL</title>
    <style>
        /* (CSS bleibt unver√§ndert - aus Platzgr√ºnden hier nicht wiederholt, aber du musst es aus der vorherigen Antwort √ºbernehmen) */
        /* Bitte kopiere das CSS aus der vorherigen Antwort - es ist identisch */
    </style>
</head>
<body>
    <!-- Lobby (gleiches HTML) -->
    <div id="lobby">
        <h1>KILL STARS</h1>
        <div class="stats-container">
            <div class="stat-box"><span>üí∞</span> <span id="totalCoinsDisplay">0</span></div>
            <div class="stat-box"><span>üèÜ</span> <span id="highScoreDisplay">0</span></div>
            <div class="stat-box"><span>üåä</span> <span id="maxWaveDisplay">1</span></div>
        </div>
        <div class="map-selector">
            <div class="map-btn" data-map="grass" id="mapGrass">üåø Gr√ºn</div>
            <div class="map-btn" data-map="desert" id="mapDesert">üèúÔ∏è W√ºste</div>
            <div class="map-btn" data-map="ice" id="mapIce">‚ùÑÔ∏è Eis</div>
        </div>
        <div class="brawler-showcase">
            <div class="arrow" id="prevBrawler">‚óÄ</div>
            <div class="brawler-card-large" id="brawlerCard">
                <div class="brawler-emoji-large" id="brawlerEmoji">üî´</div>
                <div class="brawler-name-large" id="brawlerName">Shelly</div>
                <div class="brawler-stats-large">
                    <span>‚ù§Ô∏è <span id="brawlerHp">100</span></span>
                    <span>‚ö° <span id="brawlerSpeed">3.2</span></span>
                    <span>üî´ <span id="brawlerDmg">20</span></span>
                </div>
                <div class="skin-selector">
                    <div class="skin-arrow" id="prevSkin">‚óÄ</div>
                    <div class="skin-name" id="skinName">Standard</div>
                    <div class="skin-arrow" id="nextSkin">‚ñ∂</div>
                </div>
            </div>
            <div class="arrow" id="nextBrawler">‚ñ∂</div>
        </div>
        <div class="shop-button" id="openShopBtn">üõí SHOP</div>
        <div class="play-button" id="playBtn">‚öîÔ∏è K√ÑMPFEN</div>
    </div>

    <div id="shopOverlay">
        <h2>üõí SKIN-SHOP</h2>
        <div class="shop-coins">üí∞ <span id="shopCoins">0</span></div>
        <div id="shopContent"></div>
        <div class="close-shop" id="closeShopBtn">üîô SCHLIESSEN</div>
    </div>

    <div id="gameOver">
        <div>üíÄ GAME OVER üíÄ</div>
        <div id="finalScore"></div>
        <button id="restartBtn">NEU STARTEN</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div id="wave">üåä Welle 1</div>
        <div id="hpBar">
            ‚ù§Ô∏è
            <div id="hpFill"><div id="hpCurrent"></div></div>
        </div>
        <div id="score">üèÜ 0</div>
    </div>
    <div id="leftJoystick" class="joystick"><div class="joystickKnob" id="leftKnob"></div></div>
    <div id="rightJoystick" class="joystick"><div class="joystickKnob" id="rightKnob"></div></div>
    <div id="specialButton"><span class="special-charge">0%</span><span>SPEZIAL</span></div>

    <script>
        (function() {
            // ==================== GRUNDSETUP ====================
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            // Lobby-Elemente
            const lobby = document.getElementById('lobby');
            const prevBrawlerBtn = document.getElementById('prevBrawler');
            const nextBrawlerBtn = document.getElementById('nextBrawler');
            const brawlerEmoji = document.getElementById('brawlerEmoji');
            const brawlerName = document.getElementById('brawlerName');
            const brawlerHp = document.getElementById('brawlerHp');
            const brawlerSpeed = document.getElementById('brawlerSpeed');
            const brawlerDmg = document.getElementById('brawlerDmg');
            const prevSkinBtn = document.getElementById('prevSkin');
            const nextSkinBtn = document.getElementById('nextSkin');
            const skinNameSpan = document.getElementById('skinName');
            const playBtn = document.getElementById('playBtn');
            const openShopBtn = document.getElementById('openShopBtn');
            const shopOverlay = document.getElementById('shopOverlay');
            const closeShopBtn = document.getElementById('closeShopBtn');
            const shopContent = document.getElementById('shopContent');
            const shopCoinsSpan = document.getElementById('shopCoins');
            const totalCoinsDisplay = document.getElementById('totalCoinsDisplay');
            const highScoreDisplay = document.getElementById('highScoreDisplay');
            const maxWaveDisplay = document.getElementById('maxWaveDisplay');

            // Map-Buttons
            const mapGrass = document.getElementById('mapGrass');
            const mapDesert = document.getElementById('mapDesert');
            const mapIce = document.getElementById('mapIce');

            // GameOver
            const gameOverDiv = document.getElementById('gameOver');
            const finalScoreSpan = document.getElementById('finalScore');
            const restartBtn = document.getElementById('restartBtn');

            // HUD
            const waveDisplay = document.getElementById('wave');
            const scoreDisplay = document.getElementById('score');
            const hpCurrent = document.getElementById('hpCurrent');
            const specialBtn = document.getElementById('specialButton');

            // Joysticks
            const leftJoystick = document.getElementById('leftJoystick');
            const rightJoystick = document.getElementById('rightJoystick');
            const leftKnob = document.getElementById('leftKnob');
            const rightKnob = document.getElementById('rightKnob');

            // ==================== DATEN ====================
            const maps = [
                { id: 'grass', name: 'Gr√ºn', bgColor: '#4caf7a', patternColor: '#3d8c5c', lightColor: '#6fb56f' },
                { id: 'desert', name: 'W√ºste', bgColor: '#c99b6b', patternColor: '#a87b4f', lightColor: '#dab07f' },
                { id: 'ice', name: 'Eis', bgColor: '#a8d0e6', patternColor: '#7fa9c4', lightColor: '#c0e0ff' }
            ];
            let selectedMap = 'grass';

            const skinData = {
                Shelly: [
                    { name: 'Standard', emoji: 'üî´', color: '#e67e22', hat: 'üß¢', price: 0 },
                    { name: 'Gold-Shelly', emoji: 'üî´‚ú®', color: '#f1c40f', hat: 'üëë', price: 100 },
                    { name: 'Nacht-Shelly', emoji: 'üî´üåô', color: '#2c3e50', hat: 'üé©', price: 200 }
                ],
                Colt: [
                    { name: 'Standard', emoji: 'üî´üî´', color: '#3498db', hat: 'ü§†', price: 0 },
                    { name: 'Feuer-Colt', emoji: 'üî•üî´', color: '#e67e22', hat: 'üî•', price: 100 },
                    { name: 'Eis-Colt', emoji: '‚ùÑÔ∏èüî´', color: '#5dade2', hat: '‚ùÑÔ∏è', price: 200 }
                ],
                Bull: [
                    { name: 'Standard', emoji: 'üêÇ', color: '#c0392b', hat: '‚õëÔ∏è', price: 0 },
                    { name: 'Kampf-Bull', emoji: 'üêÇ‚öîÔ∏è', color: '#7f8c8d', hat: '‚õëÔ∏è‚öîÔ∏è', price: 100 },
                    { name: 'Robo-Bull', emoji: 'ü§ñüêÇ', color: '#2c3e50', hat: 'üî©', price: 200 }
                ]
            };

            let ownedSkins = JSON.parse(localStorage.getItem('killStars_ownedSkins')) || {
                Shelly: [true, false, false],
                Colt: [true, false, false],
                Bull: [true, false, false]
            };
            let selectedSkinIndices = JSON.parse(localStorage.getItem('killStars_selectedSkins')) || {
                Shelly: 0,
                Colt: 0,
                Bull: 0
            };

            let totalCoins = parseInt(localStorage.getItem('killStars_totalCoins')) || 0;
            let highScore = parseInt(localStorage.getItem('killStars_highScore')) || 0;
            let maxWave = parseInt(localStorage.getItem('killStars_maxWave')) || 1;

            function saveStats() {
                localStorage.setItem('killStars_totalCoins', totalCoins);
                localStorage.setItem('killStars_highScore', highScore);
                localStorage.setItem('killStars_maxWave', maxWave);
                localStorage.setItem('killStars_ownedSkins', JSON.stringify(ownedSkins));
                localStorage.setItem('killStars_selectedSkins', JSON.stringify(selectedSkinIndices));
            }

            function updateLobbyStats() {
                totalCoinsDisplay.textContent = totalCoins;
                highScoreDisplay.textContent = highScore;
                maxWaveDisplay.textContent = maxWave;
            }
            updateLobbyStats();

            // ==================== BRAWLER-LISTE (VOLLST√ÑNDIG) ====================
            const brawlersList = [
                { 
                    name: 'Shelly', 
                    baseHp: 100, 
                    speed: 3.2, 
                    baseDamage: 20,
                    attackDamage: 20, 
                    attackSpeed: 8, 
                    attackRange: 350, 
                    attackSpread: 5, 
                    attackCooldown: 300,
                    specialDamage: 40, 
                    specialSpeed: 12, 
                    specialRange: 450, 
                    specialSpread: 9,
                    specialType: 'shotgun'
                },
                { 
                    name: 'Colt', 
                    baseHp: 80, 
                    speed: 4.0, 
                    baseDamage: 30,
                    attackDamage: 30, 
                    attackSpeed: 14, 
                    attackRange: 600, 
                    attackSpread: 1, 
                    attackCooldown: 250,
                    specialDamage: 25, 
                    specialSpeed: 16, 
                    specialRange: 700, 
                    specialSpread: 8,
                    specialType: 'rapid'
                },
                { 
                    name: 'Bull', 
                    baseHp: 130, 
                    speed: 2.5, 
                    baseDamage: 50,
                    attackDamage: 50, 
                    attackSpeed: 9, 
                    attackRange: 220, 
                    attackSpread: 1, 
                    attackCooldown: 350,
                    specialDamage: 90, 
                    specialSpeed: 22, 
                    specialRange: 300, 
                    specialSpread: 1,
                    specialType: 'dash'
                }
            ];

            let selectedBrawlerIndex = 0;
            let currentBrawlerName = 'Shelly';

            // ==================== UI AKTUALISIEREN ====================
            function updateBrawlerDisplay() {
                const b = brawlersList[selectedBrawlerIndex];
                currentBrawlerName = b.name;
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                brawlerEmoji.textContent = skin.emoji;
                brawlerName.textContent = b.name;
                brawlerHp.textContent = b.baseHp;
                brawlerSpeed.textContent = b.speed;
                brawlerDmg.textContent = b.baseDamage;
                skinNameSpan.textContent = skin.name;
            }

            function updateSkinDisplay() {
                const b = brawlersList[selectedBrawlerIndex];
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                brawlerEmoji.textContent = skin.emoji;
                skinNameSpan.textContent = skin.name;
            }

            // Brawler wechseln
            prevBrawlerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex - 1 + brawlersList.length) % brawlersList.length;
                updateBrawlerDisplay();
            });
            prevBrawlerBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex - 1 + brawlersList.length) % brawlersList.length;
                updateBrawlerDisplay();
            });

            nextBrawlerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex + 1) % brawlersList.length;
                updateBrawlerDisplay();
            });
            nextBrawlerBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                selectedBrawlerIndex = (selectedBrawlerIndex + 1) % brawlersList.length;
                updateBrawlerDisplay();
            });

            // Skin wechseln
            function cycleSkin(direction) {
                const b = brawlersList[selectedBrawlerIndex];
                const owned = ownedSkins[b.name];
                let current = selectedSkinIndices[b.name];
                let newIndex = current;
                do {
                    newIndex = (newIndex + direction + owned.length) % owned.length;
                } while (!owned[newIndex] && newIndex !== current);
                if (owned[newIndex]) {
                    selectedSkinIndices[b.name] = newIndex;
                    saveStats();
                    updateSkinDisplay();
                }
            }

            prevSkinBtn.addEventListener('click', (e) => {
                e.preventDefault();
                cycleSkin(-1);
            });
            prevSkinBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                cycleSkin(-1);
            });

            nextSkinBtn.addEventListener('click', (e) => {
                e.preventDefault();
                cycleSkin(1);
            });
            nextSkinBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                cycleSkin(1);
            });

            // Map-Auswahl
            mapGrass.addEventListener('click', () => {
                selectedMap = 'grass';
                document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('selected'));
                mapGrass.classList.add('selected');
            });
            mapDesert.addEventListener('click', () => {
                selectedMap = 'desert';
                document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('selected'));
                mapDesert.classList.add('selected');
            });
            mapIce.addEventListener('click', () => {
                selectedMap = 'ice';
                document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('selected'));
                mapIce.classList.add('selected');
            });
            mapGrass.classList.add('selected');

            // Shop
            function openShop() {
                shopOverlay.style.display = 'flex';
                renderShop();
            }
            function closeShop() {
                shopOverlay.style.display = 'none';
            }
            openShopBtn.addEventListener('click', openShop);
            openShopBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                openShop();
            });
            closeShopBtn.addEventListener('click', closeShop);
            closeShopBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                closeShop();
            });

            function renderShop() {
                shopCoinsSpan.textContent = totalCoins;
                let html = '';
                for (let brawler of brawlersList) {
                    html += `<div class="shop-brawler-section">`;
                    html += `<div class="shop-brawler-title"><span>${skinData[brawler.name][0].emoji}</span> ${brawler.name}</div>`;
                    for (let i = 0; i < skinData[brawler.name].length; i++) {
                        const skin = skinData[brawler.name][i];
                        const owned = ownedSkins[brawler.name][i];
                        html += `<div class="shop-skin-item">`;
                        html += `<div class="shop-skin-info">`;
                        html += `<span class="shop-skin-emoji">${skin.emoji}</span>`;
                        html += `<span class="shop-skin-name">${skin.name}</span>`;
                        html += `</div>`;
                        if (owned) {
                            html += `<span class="shop-skin-price">‚úîÔ∏è Besitzt</span>`;
                        } else {
                            html += `<span class="shop-skin-price">üí∞ ${skin.price}</span>`;
                            html += `<button class="shop-buy-btn" data-brawler="${brawler.name}" data-skinindex="${i}">Kaufen</button>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
                shopContent.innerHTML = html;

                document.querySelectorAll('.shop-buy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const brawler = e.target.dataset.brawler;
                        const skinIndex = parseInt(e.target.dataset.skinindex);
                        const price = skinData[brawler][skinIndex].price;
                        if (totalCoins >= price && !ownedSkins[brawler][skinIndex]) {
                            totalCoins -= price;
                            ownedSkins[brawler][skinIndex] = true;
                            saveStats();
                            updateLobbyStats();
                            renderShop();
                        }
                    });
                });
            }

            // ==================== SPIEL STARTEN ====================
            playBtn.addEventListener('click', () => {
                lobby.style.display = 'none';
                startGame();
            });
            playBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                lobby.style.display = 'none';
                startGame();
            });

            // Spielvariablen
            let gameActive = false;
            let player = null;
            let enemies = [];
            let projectiles = [];
            let coins = [];
            let damageNumbers = [];
            let effects = [];
            let lastShot = 0;
            const MAX_SPECIAL = 100;
            let specialCharge = 0;
            let specialReady = false;
            let wave = 1;
            let score = 0;
            let enemiesThisWave = 0;
            let enemiesSpawned = 0;
            const BASE_ENEMIES = 3;

            // Joystick-Zust√§nde
            let leftStick = { active: false, id: null, dir: { x: 0, y: 0 } };
            let rightStick = { active: false, id: null, dir: { x: 0, y: 0 }, tap: false, startX: 0, startY: 0 };

            // Spezial-Zielen
            let specialAiming = false;
            let specialDir = { x: 0, y: 0 };
            let specialStartPos = { x: 0, y: 0 };
            let specialTap = false;
            let specialTouchId = null;

            function startGame() {
                console.log("startGame() aufgerufen");
                const b = brawlersList[selectedBrawlerIndex];
                const skinIndex = selectedSkinIndices[b.name];
                const skin = skinData[b.name][skinIndex];
                
                // Explizit alle Eigenschaften kopieren
                player = {
                    name: b.name,
                    baseHp: b.baseHp,
                    speed: b.speed,
                    baseDamage: b.baseDamage,
                    attackDamage: b.attackDamage,
                    attackSpeed: b.attackSpeed,
                    attackRange: b.attackRange,
                    attackSpread: b.attackSpread,
                    attackCooldown: b.attackCooldown,
                    specialDamage: b.specialDamage,
                    specialSpeed: b.specialSpeed,
                    specialRange: b.specialRange,
                    specialSpread: b.specialSpread,
                    specialType: b.specialType,
                    hp: b.baseHp,
                    maxHp: b.baseHp,
                    color: skin.color,
                    emoji: skin.emoji,
                    hat: skin.hat
                };
                console.log("Spieler erstellt:", player);
                
                gameActive = true;
                wave = 1;
                score = 0;
                specialCharge = 0;
                specialReady = false;
                specialBtn.classList.remove('ready');
                enemies = [];
                projectiles = [];
                coins = [];
                effects = [];
                damageNumbers = [];
                updateUI();
                startWave();
                gameOverDiv.style.display = 'none';
            }

            function startWave() {
                enemiesThisWave = BASE_ENEMIES + wave * 2;
                enemiesSpawned = 0;
                enemies = [];
                spawnEnemies();
            }

            function spawnEnemies() {
                if (!gameActive) return;
                if (enemiesSpawned < enemiesThisWave) {
                    let angle = Math.random() * 2 * Math.PI;
                    let distance = Math.max(canvas.width, canvas.height) * 0.5;
                    let x = player.x + Math.cos(angle) * distance;
                    let y = player.y + Math.sin(angle) * distance;
                    x = Math.min(canvas.width - 50, Math.max(50, x));
                    y = Math.min(canvas.height - 50, Math.max(50, y));
                    
                    const enemyDamage = 5 + wave; 
                    
                    enemies.push({
                        x, y,
                        hp: 40 + wave * 8,
                        maxHp: 40 + wave * 8,
                        speed: 1.2 + wave * 0.1,
                        damage: enemyDamage,
                        radius: 25,
                        color: '#c13b3b',
                        eyeColor: '#ff0000',
                        lastDamageTime: 0
                    });
                    enemiesSpawned++;
                    setTimeout(spawnEnemies, 700);
                }
            }

            // ==================== JOYSTICK-TOUCH ====================
            function handleTouchStart(e, isRight) {
                e.preventDefault();
                const touches = e.changedTouches;
                for (let touch of touches) {
                    if (isRight && !rightStick.active) {
                        rightStick.active = true;
                        rightStick.id = touch.identifier;
                        rightStick.startX = touch.clientX;
                        rightStick.startY = touch.clientY;
                        rightStick.tap = true;
                        rightStick.dir = { x: 0, y: 0 };
                        rightKnob.style.left = '35px';
                        rightKnob.style.top = '35px';
                        break;
                    } else if (!isRight && !leftStick.active) {
                        leftStick.active = true;
                        leftStick.id = touch.identifier;
                        leftStick.dir = { x: 0, y: 0 };
                        leftKnob.style.left = '35px';
                        leftKnob.style.top = '35px';
                        break;
                    }
                }
            }

            function handleTouchMove(e, isRight) {
                e.preventDefault();
                const touches = e.touches;
                for (let touch of touches) {
                    if (isRight && rightStick.active && touch.identifier === rightStick.id) {
                        const rect = rightJoystick.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        let dx = touch.clientX - centerX;
                        let dy = touch.clientY - centerY;
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        const maxDist = rect.width / 2;
                        if (distance > maxDist) {
                            dx = (dx / distance) * maxDist;
                            dy = (dy / distance) * maxDist;
                        }
                        rightKnob.style.left = (35 + dx) + 'px';
                        rightKnob.style.top = (35 + dy) + 'px';
                        const normX = dx / maxDist;
                        const normY = dy / maxDist;
                        rightStick.dir = { x: normX, y: normY };
                        if (distance > 10) rightStick.tap = false;
                        break;
                    } else if (!isRight && leftStick.active && touch.identifier === leftStick.id) {
                        const rect = leftJoystick.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        let dx = touch.clientX - centerX;
                        let dy = touch.clientY - centerY;
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        const maxDist = rect.width / 2;
                        if (distance > maxDist) {
                            dx = (dx / distance) * maxDist;
                            dy = (dy / distance) * maxDist;
                        }
                        leftKnob.style.left = (35 + dx) + 'px';
                        leftKnob.style.top = (35 + dy) + 'px';
                        leftStick.dir = { x: dx / maxDist, y: dy / maxDist };
                        break;
                    }
                }
            }

            function handleTouchEnd(e, isRight) {
                e.preventDefault();
                const touches = e.changedTouches;
                for (let touch of touches) {
                    if (isRight && rightStick.active && touch.identifier === rightStick.id) {
                        if (rightStick.tap) {
                            autoShoot();
                        } else {
                            if (rightStick.dir.x !== 0 || rightStick.dir.y !== 0) {
                                shootInDirection(rightStick.dir);
                            }
                        }
                        rightStick.active = false;
                        rightStick.id = null;
                        rightStick.dir = { x: 0, y: 0 };
                        rightKnob.style.left = '35px';
                        rightKnob.style.top = '35px';
                        break;
                    } else if (!isRight && leftStick.active && touch.identifier === leftStick.id) {
                        leftStick.active = false;
                        leftStick.id = null;
                        leftStick.dir = { x: 0, y: 0 };
                        leftKnob.style.left = '35px';
                        leftKnob.style.top = '35px';
                        break;
                    }
                }
            }

            leftJoystick.addEventListener('touchstart', (e) => handleTouchStart(e, false), { passive: false });
            leftJoystick.addEventListener('touchmove', (e) => handleTouchMove(e, false), { passive: false });
            leftJoystick.addEventListener('touchend', (e) => handleTouchEnd(e, false));
            leftJoystick.addEventListener('touchcancel', (e) => handleTouchEnd(e, false));

            rightJoystick.addEventListener('touchstart', (e) => handleTouchStart(e, true), { passive: false });
            rightJoystick.addEventListener('touchmove', (e) => handleTouchMove(e, true), { passive: false });
            rightJoystick.addEventListener('touchend', (e) => handleTouchEnd(e, true));
            rightJoystick.addEventListener('touchcancel', (e) => handleTouchEnd(e, true));

            // ==================== SPEZIAL-ZIELEN ====================
            specialBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!specialReady || !gameActive || !player) return;
                const touch = e.changedTouches[0];
                if (!touch) return;
                specialAiming = true;
                specialTouchId = touch.identifier;
                specialStartPos.x = touch.clientX;
                specialStartPos.y = touch.clientY;
                specialTap = true;
                specialDir = { x: 0, y: 0 };
            }, { passive: false });

            specialBtn.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!specialAiming || !gameActive || !player) return;
                const touches = e.touches;
                for (let touch of touches) {
                    if (touch.identifier === specialTouchId) {
                        let dx = touch.clientX - specialStartPos.x;
                        let dy = touch.clientY - specialStartPos.y;
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance > 10) specialTap = false;
                        if (distance > 0) {
                            const len = Math.min(distance, 100) / 100;
                            specialDir.x = (dx / distance) * len;
                            specialDir.y = (dy / distance) * len;
                        }
                        break;
                    }
                }
            }, { passive: false });

            specialBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!specialAiming || !gameActive || !player) return;
                const touches = e.changedTouches;
                for (let touch of touches) {
                    if (touch.identifier === specialTouchId) {
                        if (specialTap) {
                            useSpecialAuto();
                        } else {
                            if (specialDir.x !== 0 || specialDir.y !== 0) {
                                useSpecialDirection(specialDir);
                            } else {
                                useSpecialAuto();
                            }
                        }
                        specialAiming = false;
                        specialTouchId = null;
                        specialDir = { x: 0, y: 0 };
                        break;
                    }
                }
            }, { passive: false });

            specialBtn.addEventListener('touchcancel', (e) => {
                specialAiming = false;
                specialTouchId = null;
                specialDir = { x: 0, y: 0 };
            });

            // ==================== SPEZIAL AUSF√úHREN ====================
            function useSpecialAuto() {
                if (!specialReady || !player || !gameActive) return;
                let closest = null;
                let minDist = Infinity;
                enemies.forEach(e => {
                    let d = Math.hypot(e.x - player.x, e.y - player.y);
                    if (d < minDist) {
                        minDist = d;
                        closest = e;
                    }
                });
                if (closest) {
                    let dx = closest.x - player.x;
                    let dy = closest.y - player.y;
                    let len = Math.hypot(dx, dy);
                    if (len > 0) {
                        useSpecialDirection({ x: dx / len, y: dy / len });
                    } else {
                        useSpecialDirection({ x: 1, y: 0 });
                    }
                } else {
                    useSpecialDirection({ x: 1, y: 0 });
                }
            }

            function useSpecialDirection(dir) {
                if (!specialReady || !player || !gameActive) return;

                if (player.specialType === 'dash') {
                    const dashDistance = 150;
                    const targetX = player.x + dir.x * dashDistance;
                    const targetY = player.y + dir.y * dashDistance;
                    
                    player.x = Math.min(canvas.width - 40, Math.max(40, targetX));
                    player.y = Math.min(canvas.height - 40, Math.max(40, targetY));
                    
                    enemies.forEach(e => {
                        let d = Math.hypot(player.x - e.x, player.y - e.y);
                        if (d < 70) {
                            e.hp -= player.specialDamage;
                            addDamageNumber(e.x, e.y, player.specialDamage);
                            addEffect(e.x, e.y);
                        }
                    });
                    enemies = enemies.filter(e => e.hp > 0);
                    
                    specialCharge = 0;
                    specialReady = false;
                    specialBtn.classList.remove('ready');
                    updateUI();
                    return;
                }

                if (player.specialType === 'rapid') {
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            if (!gameActive || !player) return;
                            let angle = Math.atan2(dir.y, dir.x) + (i - 3.5) * 0.1;
                            projectiles.push({
                                x: player.x, y: player.y,
                                vx: Math.cos(angle) * player.specialSpeed,
                                vy: Math.sin(angle) * player.specialSpeed,
                                damage: player.specialDamage,
                                range: player.specialRange,
                                owner: 'player',
                                size: 8,
                                color: '#ffaa00'
                            });
                        }, i * 70);
                    }
                } else {
                    let bullets = [];
                    let baseAngle = Math.atan2(dir.y, dir.x);
                    let spread = player.specialSpread || 9;
                    for (let i = -Math.floor(spread/2); i <= Math.floor(spread/2); i++) {
                        let angle = baseAngle + i * 0.15;
                        bullets.push({
                            x: player.x, y: player.y,
                            vx: Math.cos(angle) * player.specialSpeed,
                            vy: Math.sin(angle) * player.specialSpeed,
                            damage: player.specialDamage,
                            range: player.specialRange,
                            owner: 'player',
                            size: 10,
                            color: '#ff5500'
                        });
                    }
                    projectiles.push(...bullets);
                }

                specialCharge = 0;
                specialReady = false;
                specialBtn.classList.remove('ready');
                updateUI();
            }

            // ==================== NORMALES SCHIESSEN ====================
            function autoShoot() {
                if (!player || !gameActive) return;
                let closest = null;
                let minDist = Infinity;
                enemies.forEach(e => {
                    let d = Math.hypot(e.x - player.x, e.y - player.y);
                    if (d < minDist) {
                        minDist = d;
                        closest = e;
                    }
                });
                if (closest) {
                    let dx = closest.x - player.x;
                    let dy = closest.y - player.y;
                    let len = Math.hypot(dx, dy);
                    if (len > 0) {
                        shootInDirection({ x: dx / len, y: dy / len });
                    }
                }
            }

            function shootInDirection(dir) {
                if (!player || !gameActive) return;
                let now = Date.now();
                if (now - lastShot < player.attackCooldown) return;
                lastShot = now;

                let bullets = [];
                let baseAngle = Math.atan2(dir.y, dir.x);
                let spread = player.attackSpread || 1;
                if (spread === 1) {
                    bullets.push({
                        x: player.x, y: player.y,
                        vx: dir.x * player.attackSpeed,
                        vy: dir.y * player.attackSpeed,
                        damage: player.attackDamage,
                        range: player.attackRange,
                        owner: 'player',
                        size: 8,
                        color: '#ffcc44'
                    });
                } else {
                    for (let i = -Math.floor(spread/2); i <= Math.floor(spread/2); i++) {
                        let angle = baseAngle + i * 0.2;
                        bullets.push({
                            x: player.x, y: player.y,
                            vx: Math.cos(angle) * player.attackSpeed,
                            vy: Math.sin(angle) * player.attackSpeed,
                            damage: player.attackDamage,
                            range: player.attackRange,
                            owner: 'player',
                            size: 6,
                            color: '#ffaa00'
                        });
                    }
                }
                projectiles.push(...bullets);
            }

            // ==================== HILFSFUNKTIONEN ====================
            function addDamageNumber(x, y, amount) {
                damageNumbers.push({ x, y: y-20, value: amount, life: 60 });
            }
            function addCoin(x, y) {
                coins.push({ x, y, value: 50, life: 300 });
            }
            function addEffect(x, y) {
                effects.push({ x, y, life: 20, maxLife: 20 });
            }

            function updateUI() {
                if (!player) return;
                waveDisplay.innerHTML = `üåä Welle ${wave}`;
                scoreDisplay.innerHTML = `üèÜ ${score}`;
                let percent = (player.hp / player.maxHp) * 100;
                hpCurrent.style.width = percent + '%';
                specialBtn.querySelector('.special-charge').innerText = Math.min(100, Math.floor(specialCharge)) + '%';
                if (specialCharge >= MAX_SPECIAL && !specialReady) {
                    specialReady = true;
                    specialBtn.classList.add('ready');
                }
            }

            // ==================== UPDATE ====================
            function update() {
                if (!gameActive || !player) {
                    return;
                }

                // Bewegung
                if (leftStick.active) {
                    player.x += leftStick.dir.x * player.speed;
                    player.y += leftStick.dir.y * player.speed;
                    player.x = Math.min(canvas.width - 40, Math.max(40, player.x));
                    player.y = Math.min(canvas.height - 40, Math.max(40, player.y));
                }

                // Gegner bewegen
                enemies.forEach(e => {
                    let dx = player.x - e.x;
                    let dy = player.y - e.y;
                    let len = Math.hypot(dx, dy);
                    if (len > 0) {
                        e.vx = (dx / len) * e.speed;
                        e.vy = (dy / len) * e.speed;
                    }
                    e.x += e.vx;
                    e.y += e.vy;
                    e.x = Math.min(canvas.width - 30, Math.max(30, e.x));
                    e.y = Math.min(canvas.height - 30, Math.max(30, e.y));
                });

                // Projektile
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    let p = projectiles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                        projectiles.splice(i, 1);
                        continue;
                    }
                    let dist = Math.hypot(p.x - player.x, p.y - player.y);
                    if (dist > p.range) {
                        projectiles.splice(i, 1);
                        continue;
                    }
                    if (p.owner === 'player') {
                        for (let j = enemies.length - 1; j >= 0; j--) {
                            let e = enemies[j];
                            let d = Math.hypot(p.x - e.x, p.y - e.y);
                            if (d < e.radius + 5) {
                                e.hp -= p.damage;
                                addDamageNumber(e.x, e.y, p.damage);
                                addEffect(p.x, p.y);
                                specialCharge += 10;
                                if (specialCharge > MAX_SPECIAL) specialCharge = MAX_SPECIAL;
                                projectiles.splice(i, 1);
                                if (e.hp <= 0) {
                                    score += 100;
                                    specialCharge += 20;
                                    if (specialCharge > MAX_SPECIAL) specialCharge = MAX_SPECIAL;
                                    addCoin(e.x, e.y);
                                    enemies.splice(j, 1);
                                }
                                break;
                            }
                        }
                    }
                }

                // Gegner-Schaden
                const now = Date.now();
                for (let i = 0; i < enemies.length; i++) {
                    let e = enemies[i];
                    let d = Math.hypot(player.x - e.x, player.y - e.y);
                    if (d < 35 + e.radius) {
                        if (now - e.lastDamageTime > 500) {
                            player.hp -= e.damage;
                            addDamageNumber(player.x, player.y, e.damage);
                            addEffect(player.x, player.y);
                            e.lastDamageTime = now;
                            if (player.hp <= 0) {
                                gameActive = false;
                                if (score > highScore) {
                                    highScore = score;
                                }
                                if (wave > maxWave) {
                                    maxWave = wave;
                                }
                                saveStats();
                                gameOverDiv.style.display = 'flex';
                                finalScoreSpan.innerText = 'Punkte: ' + score;
                                return;
                            }
                        }
                    }
                }

                // M√ºnzen
                for (let i = coins.length - 1; i >= 0; i--) {
                    let c = coins[i];
                    let d = Math.hypot(player.x - c.x, player.y - c.y);
                    if (d < 40 + 15) {
                        score += c.value;
                        totalCoins += c.value;
                        addEffect(c.x, c.y);
                        coins.splice(i, 1);
                        saveStats();
                        updateLobbyStats();
                    }
                }

                // N√§chste Welle
                if (enemies.length === 0 && enemiesSpawned >= enemiesThisWave) {
                    wave++;
                    startWave();
                }

                // Lebensdauer
                for (let i = effects.length - 1; i >= 0; i--) {
                    effects[i].life--;
                    if (effects[i].life <= 0) effects.splice(i, 1);
                }
                for (let i = coins.length - 1; i >= 0; i--) {
                    coins[i].life--;
                    if (coins[i].life <= 0) coins.splice(i, 1);
                }
                for (let i = damageNumbers.length - 1; i >= 0; i--) {
                    damageNumbers[i].life--;
                    if (damageNumbers[i].life <= 0) damageNumbers.splice(i, 1);
                }

                updateUI();
            }

            // ==================== ZEICHNEN ====================
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Map zeichnen
                const map = maps.find(m => m.id === selectedMap);
                ctx.fillStyle = map.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = map.lightColor;
                for (let i = 0; i < 30; i++) {
                    ctx.beginPath();
                    ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 20, 0, 2*Math.PI);
                    ctx.globalAlpha = 0.15;
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
                ctx.strokeStyle = map.patternColor;
                ctx.lineWidth = 2;
                for (let i = 0; i < canvas.width; i += 70) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i < canvas.height; i += 70) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }

                if (!gameActive || !player) {
                    return;
                }

                // Zielhilfen
                if (rightStick.active && (rightStick.dir.x !== 0 || rightStick.dir.y !== 0)) {
                    drawAim(player, rightStick.dir, player.attackRange, player.attackSpread, 'rgba(255,255,255,0.5)');
                }
                if (specialAiming && (specialDir.x !== 0 || specialDir.y !== 0)) {
                    drawAim(player, specialDir, player.specialRange, player.specialSpread, 'rgba(255,100,0,0.7)');
                }

                // Effekte
                effects.forEach(e => {
                    let progress = e.life / e.maxLife;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, 30 * (1 - progress), 0, 2*Math.PI);
                    ctx.fillStyle = `rgba(255, 150, 0, ${progress})`;
                    ctx.fill();
                });

                // M√ºnzen
                coins.forEach(c => {
                    ctx.save();
                    ctx.shadowColor = 'gold';
                    ctx.shadowBlur = 20;
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, 15, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#B8860B';
                    ctx.font = '20px Arial';
                    ctx.fillText('üí∞', c.x-12, c.y+8);
                    ctx.restore();
                });

                // Projektile
                projectiles.forEach(p => {
                    ctx.save();
                    ctx.shadowColor = 'yellow';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.restore();
                });

                // Gegner
                enemies.forEach(e => {
                    ctx.save();
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = e.color;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, e.radius, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.strokeStyle = '#5a3a2a';
                    ctx.lineWidth = 4;
                    ctx.stroke();

                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(e.x-10, e.y-8, 7, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(e.x+10, e.y-8, 7, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(e.x-10, e.y-8, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(e.x+10, e.y-8, 4, 0, 2*Math.PI);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.moveTo(e.x-18, e.y-20);
                    ctx.lineTo(e.x-6, e.y-16);
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = 'black';
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(e.x+18, e.y-20);
                    ctx.lineTo(e.x+6, e.y-16);
                    ctx.stroke();

                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#c0392b';
                    ctx.fillRect(e.x-25, e.y-40, 50, 6);
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(e.x-25, e.y-40, 50 * (e.hp/e.maxHp), 6);
                    ctx.restore();
                });

                // Spieler
                ctx.save();
                ctx.shadowColor = 'white';
                ctx.shadowBlur = 25;
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 30, 0, 2*Math.PI);
                ctx.fill();
                ctx.strokeStyle = 'gold';
                ctx.lineWidth = 5;
                ctx.stroke();

                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(player.x-12, player.y-10, 8, 0, 2*Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(player.x+12, player.y-10, 8, 0, 2*Math.PI);
                ctx.fill();
                ctx.fillStyle = '#2c3e50';
                ctx.beginPath();
                ctx.arc(player.x-12, player.y-10, 4, 0, 2*Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(player.x+12, player.y-10, 4, 0, 2*Math.PI);
                ctx.fill();

                ctx.font = '30px Arial';
                ctx.fillStyle = 'white';
                ctx.shadowBlur = 10;
                ctx.fillText(player.hat, player.x-15, player.y-50);
                ctx.fillText(player.emoji, player.x-20, player.y-80);
                ctx.restore();

                // Schadenszahlen
                ctx.save();
                ctx.font = 'bold 26px Arial';
                ctx.textAlign = 'center';
                damageNumbers.forEach(d => {
                    let alpha = d.life / 60;
                    ctx.fillStyle = `rgba(255, 50, 50, ${alpha})`;
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.strokeText('-' + d.value, d.x, d.y);
                    ctx.fillText('-' + d.value, d.x, d.y);
                });
                ctx.restore();
            }

            function drawAim(player, dir, range, spread, color) {
                if (!player || !dir) return;
                let baseAngle = Math.atan2(dir.y, dir.x);
                
                if (player.name === 'Shelly') {
                    let spreadAngle = 0.8;
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y);
                    let angle1 = baseAngle - spreadAngle/2;
                    let angle2 = baseAngle + spreadAngle/2;
                    let x1 = player.x + Math.cos(angle1) * range;
                    let y1 = player.y + Math.sin(angle1) * range;
                    let x2 = player.x + Math.cos(angle2) * range;
                    let y2 = player.y + Math.sin(angle2) * range;
                    ctx.lineTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else if (player.name === 'Colt') {
                    let endX = player.x + dir.x * range;
                    let endY = player.y + dir.y * range;
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y);
                    ctx.lineTo(endX, endY);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 6;
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(endX, endY, 12, 0, 2*Math.PI);
                    ctx.fillStyle = 'rgba(255,0,0,0.7)';
                    ctx.fill();
                } else if (player.name === 'Bull') {
                    let dashRange = 150;
                    let endX = player.x + dir.x * dashRange;
                    let endY = player.y + dir.y * dashRange;
                    ctx.beginPath();
                    ctx.moveTo(player.x, player.y);
                    ctx.lineTo(endX, endY);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    let arrowSize = 15;
                    let angle = Math.atan2(dir.y, dir.x);
                    let leftX = endX - arrowSize * Math.cos(angle - 0.5);
                    let leftY = endY - arrowSize * Math.sin(angle - 0.5);
                    let rightX = endX - arrowSize * Math.cos(angle + 0.5);
                    let rightY = endY - arrowSize * Math.sin(angle + 0.5);
                    ctx.beginPath();
                    ctx.moveTo(endX, endY);
                    ctx.lineTo(leftX, leftY);
                    ctx.lineTo(rightX, rightY);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(endX, endY, 20, 0, 2*Math.PI);
                    ctx.fillStyle = 'rgba(255,0,0,0.5)';
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            }

            // ==================== GAMELOOP ====================
            function gameLoop() {
                update();
                draw();
                requestAnimationFrame(gameLoop);
            }
            gameLoop();

            restartBtn.addEventListener('click', () => {
                gameOverDiv.style.display = 'none';
                lobby.style.display = 'flex';
                updateLobbyStats();
            });
            restartBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameOverDiv.style.display = 'none';
                lobby.style.display = 'flex';
                updateLobbyStats();
            });

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                if (player) {
                    player.x = Math.min(canvas.width-40, Math.max(40, player.x));
                    player.y = Math.min(canvas.height-40, Math.max(40, player.y));
                }
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            updateBrawlerDisplay();
        })();
    </script>
</body>
</html>
